{% trans_default_domain 'NIPAProjetBundle' %}
		
{% block body %}

    {# TEST LES DROITS USER#}
    {% set droit = 0 %}
    {% for groupe in user.getGroupesToArray() %} 
        {% if groupe.getPermission() %} {# Test si le groupe a des permissions #}
            {% if (groupe.getPermission().getCMSProjet() == 1) %} {# Si oui on test les droits d'accès #}
                {% set droit = droit + 1 %}  
            {% endif %}    
        {% endif %}
    {% endfor %}  

    <h4 class=""><i class="fa fa-dollar fa-fw"></i> {{ 'Budget '|trans }} </h4>        
        
        <div class="row col-md-13">

            <!-- PANEL -->          
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">  
                        Informations Budget Projet
                    </h3>
                    <div class="pull-right">  
                         xxx
                        <span data-toggle="collapse" data-target="#collapseInstances" class="clickable collapsed" title="Afficher détails" data-container="body">
                            <i class="glyphicon glyphicon-plus"></i>
                        </span>
                    </div>                
                </div>   
            <div id="collapseInstances" class="panel-collapse collapse">                                
                <div class="panel-body">

                    <table class="table table-hover" id="champs-table-resume-instance">
                        <thead>
                            <tr>
                                <th class="text-center">Phase</th>
                                <th class="text-center">Date</th>
                                <th class="text-center">Montant</th>
                                <th class="text-center">Action</th>     
                            </tr>
                        </thead>
                        <tbody>
                        {% if projet.referenceProjet %} 
                            {# {% for instance in listDemandeInstance %} #}
                                <tr>
                                    <td class="text-center"><h5><strong></strong></h5></td>
                                    <td class="text-center"><h5></h5></td>
                                    <td class="text-center"><h5></h5></td>
                                    {% if droit != 0 %}
                                        <td id="delete-instance" class="text-center"><a id="" class="btn btn-danger confirmModalBudget"><i class="glyphicon glyphicon-remove"></i> </a></td>                    
                                    {% else %}
                                        <td id="delete-instance" class="text-center"><a id="" class="btn btn-danger confirmModalBudget" DISABLED><i class="glyphicon glyphicon-remove"></i> </a></td>                    
                                    {% endif %}
                                </tr>
                            {# {% endfor %} #}                        
                        {% endif %}
                        </tbody>
                    </table>

                </div> 
            </div>           
                {% if projet.referenceProjet %} 
                <form action="" method="post"  id="form_ajouter_budget" >
                    <table class="table" id="champs-table-budget-projet">
                        <thead>
                            <tr>
                                <th class="text-center">Phase</th>
                                <th class="text-center">Date</th>
                                <th class="text-center">Montant</th>
                                <th class="text-center">Ajouter</th>                    
                            </tr>
                        </thead>                   
                        <tbody>
                            <tr>
                                <td>
                                    <select class="form-control" id="phase" name="phase">
                                      <option>PE</option>
                                      <option>Etude</option>
                                      <option>...</option>
                                    </select>                                
                                </td>
                                <td><input type='text' class="form-control input-md date textinput" id='date' name="date" style="text-align:center;" required="true" /></td>
                                <td><input type="number" min="0" step="0.01" data-number-to-fixed="2" data-number-stepfactor="100" id="montant" placeholder="Montant" class="form-control input-md textinput currency" name="montant" required="true" style="text-align:center;"></td>
                                {% if droit != 0 %}
                                    <td class="text-center"><button type="submit" class="btn btn-success" id="add-budget"><i class="glyphicon glyphicon-plus"></i></button></td>
                                {% else %}
                                    <td class="text-center"><button type="submit" class="btn btn-success" id="add-budget" DISABLED><i class="glyphicon glyphicon-plus"></i></button></td>
                                {% endif %}
                            </tr>   
                            {# Pour l'erreur: "Le jeton CSRF est invalide" 
                            {{ form_widget(form._token) }}        
                            {{form_errors(form)}} #}
                        </tbody>   
                    </table>
                </form>    
                {% endif %}
            </div>
        </div>
                
            
    <script>    
    
    $('#date').datetimepicker({
    todayBtn:"true",
    format:"dd/mm/yyyy", 
    autoclose:"true",
    startView:"year",
    minView:"month",
    language:"fr"
    });  

    
    $(function() {

        $("#form_ajouter_instance").submit(function(){ 
        
            $.ajax({
                type: 'post',
                url: "{# {% if demande.referenceDemande %}{{ path('demande_add_instance',{'reference': demande.referenceDemande}) }}{% endif %} #}",
                data: $('#form_ajouter_instance').serialize(),
                success: function()
                {
                    alert("Ajout5 effectué avec succès! (TEST)");
                    var url = document.location.href;
                    $(location).attr('href',url+"#instances");                 
                    location.reload();        
                },
                error: function(e) {
                   console.log(e);
                 }      
            });
                return false;
        }); 
    });  
    

    $('#champs-table-resume-instance tr #delete-instance').on("click", function()
    {
        var id = $("a", this).attr("id");

        //if(confirm("Etes-vous sûr de vouloir supprimer l'item?")==true)
        //{    
            $(this).parent().remove();      

            $.post("{# {% if demande.referenceDemande %}{{ path('demande_delete_instance',{'reference': demande.referenceDemande}) }}{% endif %} #}", {id: id})
              .done(function(data) {
                alert("Suppression effectuée avec succès!");
                var url = document.location.href;
                $(location).attr('href',url+"#instances");                
                location.reload();
            });
        //}

    });

    </script>
    
{% endblock %}        